---
title: çƒŸè‰ä»“å‚¨ç®¡ç†ç³»ç»Ÿå¼€å‘ç¬”è®°ï¼ˆå…­ï¼‰
date: 2022-05-04 23:00:00
tags: å®‰å“
---
# ç®€è¿°
å¥½ä¹…æ²¡å†™ç¬”è®°äº†ï¼Œè¿™æ®µæ—¶é—´æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œä¸­é—´çš„äº”ä¸€å‡æœŸä¹Ÿæ²¡æœ‰æ¨è¿›è¿›åº¦ï¼Œæ‰€ä»¥æ€»ä½“å®Œæˆçš„å†…å®¹ä¸æ˜¯å¾ˆå¤šï¼Œå†…å®¹ä¸å¤šï¼Œé‡åˆ°çš„é—®é¢˜å´è¿˜ä¸å°‘ğŸ’¢æ•°æ¥è¿™æ®µæ—¶é—´ä¸»è¦å®Œæˆçš„å†…å®¹æœ‰ï¼šå®ç°RecycleViewä¸­Itemçš„æ·»åŠ ã€ç§»åŠ¨åŠ¨ç”»ï¼›é‡æ–°å®Œæˆäº†è®¢å•ç®¡ç†éƒ¨åˆ†çš„ç•Œé¢è®¾è®¡ï¼›ä¿®æ”¹äº†åº“å­˜ç®¡ç†éƒ¨åˆ†çš„ä¸€äº›è®¾è®¡ï¼›æ­£å¼å¼•å…¥çš„æ•°æ®åº“ï¼Œåˆ å»å‡æ•°æ®ï¼›å®ç°äº†å›¾ç‰‡çš„å¯åŠ¨æ—¶åŠ è½½ï¼›å¼•å…¥viewModelç®¡ç†æ•°æ®ï¼›å®Œæˆäº†è®¢å•ç®¡ç†ä¿¡æ¯å’Œåº“å­˜ä¿¡æ¯çš„è”åŠ¨

# RecycleViewä¸­çš„ItemåŠ¨ç”»
é¦–å…ˆæ—¶RecycleViewä¸­çš„æ·»åŠ åˆ é™¤Itemæ—¶çš„åŠ¨ç”»ï¼Œå› ä¸ºæˆ‘æ¯æ¬¡æ·»åŠ åˆ é™¤æ•°æ®éƒ½æ˜¯ä»æ•°æ®åº“è·å–ï¼Œå¹¶ä¸”æœ‰ä¸ªæ’¤é”€æ“ä½œï¼Œéœ€è¦å°†æ•°æ®æ’å›åˆ°åŸæ¥çš„ä½ç½®ï¼Œè€Œè¿™ä¸ªä½ç½®ä¸åŒçš„Itemæ˜¯ä¸ä¸€æ ·çš„ï¼Œå› æ­¤æ— æ³•ç›´æ¥ä½¿ç”¨BRVAHæä¾›çš„addDataæ–¹æ³•ï¼Œæ­¤å¤–ï¼Œå³ä½¿ä½¿ç”¨addDataæ–¹æ³•å®ç°äº†è¡¨é¢çš„æ•°æ®æ¢å¤ï¼Œä½†ç”±äºæ•°æ®åº“ä¸­ä½¿ç”¨çš„æ˜¯insertæ–¹æ³•ï¼Œå› æ­¤åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®å¹¶æ²¡æœ‰æ’å…¥åˆ°åŸæœ‰ä½ç½®ï¼Œè€Œæ˜¯æ’å…¥åˆ°äº†æœ€ä¸‹æ–¹ï¼Œè¿™æœ€ç»ˆå¯¼è‡´çš„é—®é¢˜æ˜¯adapterä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œç›´è§‚çš„è¡¨ç°å½¢å¼å°±æ˜¯ï¼šâ€œé¡ºåºä¸ºABCï¼Œåˆ é™¤äº†Båˆæ’¤é”€æ—¶ï¼Œé¡µé¢æ˜¾ç¤ºçš„ä¸ºABCï¼Œè€Œå®é™…çš„æ•°æ®é¡ºåºæ˜¯ACBï¼Œå¯¼è‡´ç‚¹å‡»B Itemæ—¶ï¼Œæ˜¾ç¤ºçš„æ•°æ®æ˜¯Cçš„ã€‚å°è¯•äº†å¾ˆå¤šæ–¹æ³•éƒ½æ²¡èƒ½å®ç°ï¼Œæœ€åå°±é‡‡ç”¨setListæ–¹æ³•é‡ç½®æ•°æ®ï¼Œæ”¾å¼ƒåŠ¨ç”»äº†ã€‚

åæ¥åœ¨æŸ¥çœ‹æ–°ç‰ˆæœ¬çš„BRVæ—¶å‘ç°å…¶å¯ä»¥æä¾›æˆ‘æƒ³è¦çš„å®ç°å½¢å¼ï¼Œäºæ˜¯è¿›è¡Œäº†å°è¯•ï¼Œä½†æœ€ç»ˆæ²¡èƒ½æˆåŠŸï¼Œä¸è¿‡è¿™æ¬¡å°è¯•ä¹Ÿè®©æˆ‘åˆå»æŸ¥çœ‹äº†ä¸€éBRVAHçš„ä»£ç ï¼Œå› ä¸ºæˆ‘å‘ç°BRVä¸­çš„è¿™éƒ¨åˆ†å†…å®¹è²Œä¼¼æ˜¯ç›´æ¥ä»BRVAHä¸­ç»§æ‰¿æ¥çš„ï¼Œæ‰€ä»¥BRVAHä¸­åº”è¯¥ä¹Ÿæä¾›äº†è¿™ç§å®ç°å½¢å¼ï¼Œæœ€ç»ˆæˆ‘å‘ç°äº†å…¶ä¸­DiffUtiléƒ¨åˆ†çš„å†…å®¹ï¼ˆä¸­æ–‡ç‰ˆæ–‡æ¡£è¿˜æ˜¯2.9ç‰ˆæœ¬çš„ï¼Œå…¶ä¸­ä¹Ÿæ²¡æœ‰å†™ç›¸å…³å†…å®¹ï¼ŒWikiä¸­å°±åªæœ‰ä¸€ä¸ªDiffUtilçš„é“¾æ¥ï¼Œè¿ä¸€ä¸ªå­—çš„ä»‹ç»éƒ½æ²¡æœ‰\==ï¼‰æœ€ç»ˆé€šè¿‡è¯¥æ¨¡å—å®ç°äº†æˆ‘æƒ³è¦çš„å®ç°å½¢å¼

## 1. æ–°å»ºè‡ªå·±çš„DiffCallbackç±»
ä»¥ç”¨æˆ·ç®¡ç†ä¸ºä¾‹
```java
public class UserDiffCallback extends DiffUtil.ItemCallback<User> {  
    /**  
     * Determine if it is the same item     * <p>  
     * åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªitem  
     *     * @param oldItem New data  
     * @param newItem old Data  
     * @return  
     */  
    @Override  
    public boolean areItemsTheSame(@NonNull User oldItem, @NonNull User newItem) {  
        return oldItem.getId().equals(newItem.getId());  
    }  
  
    /**  
     * When it is the same item, judge whether the content has changed.     * <p>  
     * å½“æ˜¯åŒä¸€ä¸ªitemæ—¶ï¼Œå†åˆ¤æ–­å†…å®¹æ˜¯å¦å‘ç”Ÿæ”¹å˜  
     *  
     * @param oldItem New data  
     * @param newItem old Data  
     * @return  
     */  
    @Override  
    public boolean areContentsTheSame(@NonNull User oldItem, @NonNull User newItem) {  
        return oldItem.getUsername().equals(newItem.getUsername())  
                && oldItem.getPassword().equals(newItem.getPassword())  
                && oldItem.getPermission() == newItem.getPermission();  
    }  
}
```
è¯¥DiffCallbackç±»ç”¨äºåˆ¤æ–­æ•°æ®æ˜¯å¦å‘ç°äº†å˜åŒ–ï¼Œå³æ˜¯å¦Diffäº†ã€‚

## 2. ä¸ºAdapterè®¾ç½®DiffCallback
ä¸ºAdapterç»‘å®šDiffCallbackç±»ï¼Œå³adapterä¸­çš„æ•°æ®æ ¹æ®é‚£ä¸ªDiffCallbackç±»åˆ¤æ–­å˜åŒ–ï¼Œå®é™…ä»£ç å°±ä¸€å¥è¯
```java
//è®¾ç½®diffCallback  
adapter.setDiffCallback(new UserDiffCallback());
```

## 3. æ›´æ–°æ•°æ®
é€šè¿‡æ–°çš„`setDiffNewData`æ–¹æ³•æ¥è®¾ç½®æ•°æ®ï¼Œè€Œä¸å†æ˜¯`setList`æ–¹æ³•
```java
userViewModel.getAllUserLive().observe(getActivity(), new Observer<List<User>>() {  
    @Override  
    public void onChanged(List<User> users) {  
        if (adapter.getData().size() == 0)  
            adapter.setNewInstance(users);  
        //é€šè¿‡setDiffNewDataæ¥é€šçŸ¥adapteræ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¿ç•™åŠ¨ç”»  
        adapter.setDiffNewData(users);  
        adapter.setList(users);  
    }  
});
```
è¿™é‡Œçš„setListæ–¹æ³•æ˜¯æˆ‘åœ¨Adapterè¿›è¡Œé‡å†™ï¼Œä¸å†åˆ·æ–°æ•°æ®ï¼Œåªæ˜¯å°†usersæ•°ç»„ä¼ é€’åˆ°Adapterä¸­è€Œå·²ï¼ˆè¿™ä¸€ä¸ªæ¼ç½‘ä¹‹é±¼ï¼Œåé¢çš„ç±»éƒ½æ”¹æˆsetMyListäº†\==ï¼‰

è¿™æ ·å°±æ¢å¤äº†æ·»åŠ åˆ é™¤Itemæ—¶çš„åŠ¨ç”»ã€‚
# è®¢å•ç®¡ç†
ä¹‹å‰çš„è®¢å•ç®¡ç†çš„è®¾è®¡æ€è·¯æ˜¯å¯ä»¥å±•å¼€çš„æ¡ç›®ï¼Œå³åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„ä¸ºç®€å•çš„ä¸»è¦ä¿¡æ¯ï¼Œç‚¹å‡»æ¡ç›®æ—¶ä¸‹æ–¹å±•å¼€ä¸€ä¸ªæ–°çš„è§†å›¾ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯ï¼Œé‚£ä¼šå„¿æˆ‘èŠ±äº†å¥½é•¿çš„æ—¶é—´æ¥å®ç°ï¼Œè™½ç„¶æœ€ç»ˆæˆäº†ï¼Œä½†ç»ˆç©¶è¿˜æ˜¯æœ‰ç‚¹å°é—®é¢˜ï¼Œè€Œä¸”è™½ç„¶ç¡¬ç›˜æŸåï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¹Ÿéƒ½æ²¡äº†ã€‚äºæ˜¯æˆ‘åˆæƒ³ç€èƒ½ä¸èƒ½æœ‰æ›´å¥½çš„å‘ˆç°æ–¹å¼ï¼Œåæ¥çœ‹åˆ°æ·˜å®çš„è´­ç‰©è½¦ç•Œé¢ï¼Œå‘ç°äº†é‡Œé¢çš„ä¸€ä¸ªä¸ªè´­ç‰©è®°å½•å¡ç‰‡ä¸­ä¹Ÿæ˜¾ç¤ºäº†å¾ˆå¤šçš„ä¿¡æ¯ï¼Œä¹Ÿç¬¦åˆâ€è®¢å•â€œè¿™ç§è®¾å®šï¼Œäºæ˜¯å°±æƒ³ç€èƒ½ä¸èƒ½åšä¸ªç±»ä¼¼æ·˜å®è´­ç‰©è½¦çš„å¡ç‰‡ç”¨äºå‘ˆç°æ•°æ®ã€‚

## ä¸»ç•Œé¢
![](https://images.starnight.top/img/20220504233946.png)

å¡ç‰‡ä¸­å»æ‰äº†å„ç§æç¤ºæ ‡ç­¾ï¼Œåƒâ€œè®¢å•å·ï¼šâ€ï¼Œâ€œç”¨æˆ·åï¼šâ€è¿™ç§ï¼Œæ˜¾å¾—è‡ƒè‚¿ï¼Œæ”¹ä¸ºç›´æ¥æ˜¾ç¤ºæ•°æ®ï¼Œé€šè¿‡é¢œè‰²çš„æ˜æš—æ¥åˆ†ä¸»æ¬¡ã€‚å…¶ä¸­çš„çŠ¶æ€æ¡†ï¼Œæ ¹æ®è®¢å•çš„å½“å‰çŠ¶æ€ä¸åŒï¼Œæœ‰ä¸åŒçš„æ˜¾ç¤ºæ•ˆæœï¼Œæ›´åŠ ç›´è§‚åœ°å±•ç¤ºè®¢å•çš„è¿›åº¦ã€‚é‡‡è´­è®¢å•åˆ†ä¸ºå››ä¸ªçŠ¶æ€ï¼šç”³è¯·ä¸­ã€å·²æ‹’ç»ã€è¿è¾“ä¸­ã€å·²å®Œæˆã€‚é”€å”®è®¢å•åˆ†ä¸ºäº”ä¸ªçŠ¶æ€ï¼šç”³è¯·ä¸­ã€å¾…å‘è´§ã€å·²æ‹’ç»ã€è¿è¾“ä¸­ã€å·²å®Œæˆã€‚è®¢å•ç®¡ç†ç•Œé¢çš„æ•´ä½“æ¡†æ¶è·Ÿå…¶ä»–é¡µé¢ä¸€è‡´ï¼Œåªæ˜¯RecycleViewä¸­çš„Itemæ ·å¼ä¸åŒè€Œå·²ã€‚
![](https://images.starnight.top/img/20220504234343.png)

## æ·»åŠ å¯¹è¯æ¡†
æ·»åŠ è®¢å•çš„å¯¹è¯æ¡†ä¸­å°±æ˜¯è¾“å…¥ä¸€äº›åŸºæœ¬ä¿¡æ¯
![](https://images.starnight.top/img/20220504234518.png)

å…¶ä¸­ç»åŠäººä¿¡æ¯é»˜è®¤é”å®šä¸ºå½“å‰ç”¨æˆ·ï¼Œä¸å…è®¸æ›´æ”¹ï¼Œé‡‡è´­æ—¥æœŸè®¾å®šä¸ºå½“å¤©ï¼Œç”¨æˆ·é€‰æ‹©è´­ä¹°çš„åŸæ–™åç§°ã€åŸæ–™å‹å·ã€ä¾›è´§å•†ä»¥åŠæ•°é‡å’Œä»·æ ¼ï¼Œå…¶ä½™ä¿¡æ¯ä¸å†æ­¤æ—¶æ·»åŠ ã€‚å…¶ä¸­çš„åç§°å’Œå‹å·çš„ä¸‹æ‹‰æ¡†é‡‡ç”¨äº†äºŒçº§è”åŠ¨ï¼Œå³å½“ç”¨æˆ·é€‰æ‹©å®ŒåŸæ–™åç§°åï¼Œæ ¹æ®åç§°æŸ¥è¯¢æ•°æ®åº“å¾—åˆ°è¯¥åç§°ä¸‹çš„å‹å·åˆ—è¡¨ï¼Œå°†å‹å·åˆ—è¡¨å¡«å……åˆ°å‹å·ä¸‹æ‹‰æ¡†ä¸­ï¼Œè¿™é‡Œä¹Ÿé‡åˆ°äº†ä¸€äº›çš„[é—®é¢˜](obsidian://open?vault=Obsidian&file=E%20-%20Output%2F%E6%AF%95%E8%AE%BE%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0%2FAndroid%20Spinner%E4%BA%8C%E7%BA%A7%E8%81%94%E5%8A%A8)ã€‚

åœ¨ç‚¹å‡»ç¡®å®šåä¾¿å‘æ•°æ®åº“ä¸­æ·»åŠ ä¸€æ¡é‡‡è´­è®¢å•è®°å½•ï¼Œè®¢å•çŠ¶æ€ä¸ºâ€ç”³è¯·ä¸­â€œï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚

## ä¿®æ”¹å¯¹è¯æ¡†
![](https://images.starnight.top/img/20220504235328.png)

åœ¨ä¿®æ”¹å¯¹è¯æ¡†ä¸­ï¼Œè®¢å•ä¿¡æ¯æ˜¾ç¤ºå¾—æ›´åŠ å®Œæ•´ï¼Œåœ¨æ­¤å¤„ç”¨æˆ·å¯ä»¥ä¿®æ”¹ä¸Šè¿°çš„åŸºæœ¬ä¿¡æ¯ï¼Œä½†å…¥åº“æ—¥æœŸå’Œç®¡ç†å‘˜æ‰¹æ³¨æ— æ³•ä¿®æ”¹ï¼Œå…¥åº“æ—¥æœŸç­‰å¾…åº“å­˜ç®¡ç†ä¸­å…¥åº“æ—¶æ›´æ–°ï¼Œç®¡ç†å‘˜æ‰¹æ³¨åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ“ä½œã€‚æ­¤å¤–ï¼Œåœ¨Adapterä¸­æ ¹æ®è®¢å•çŠ¶æ€è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœè®¢å•çŠ¶æ€æ˜¯ç”³è¯·ä¸­å’Œå·²æ‹’ç»ï¼Œåˆ™okæŒ‰é’®æ˜¾ç¤ºçš„æ–‡æœ¬æ˜¯â€é‡æ–°æäº¤â€œï¼Œå®ç°çš„åŠŸèƒ½æ˜¯å°†è®¢å•çŠ¶æ€ä¿®æ”¹ä¸ºç”³è¯·ä¸­ï¼Œé‡æ–°è¿›è¡Œç”³è¯·ï¼Œå¦‚æœè®¢å•çŠ¶æ€æ˜¯è¿è¾“ä¸­å’Œå·²å®Œæˆï¼Œåˆ™okæŒ‰é’®æ˜¾ç¤ºçš„æ–‡æœ¬æ˜¯â€ç¡®å®šâ€œï¼Œæ­¤æ—¶ç”¨æˆ·ä¸èƒ½ä¿®æ”¹è®¢å•å†…å®¹ã€‚
# åº“å­˜ç®¡ç†
åº“å­˜ç®¡ç†éƒ¨åˆ†ç›¸å¯¹äºä¹‹å‰æ‰€å®Œæˆçš„å†…å®¹æ²¡æœ‰å¤ªå¤šçš„æ”¹åŠ¨ï¼Œä¸»è¦å°±æ˜¯å·¥å…·æ çš„æ”¹åŠ¨ã€‚
å‘ç°äº†ä¸€ä¸ªè®¾è®¡çš„è‡´å‘½æ¼æ´ğŸ’£ä¾‹å¦‚äº§å“ï¼Œåªæä¾›äº†ç¡®è®¤è®¢å•çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯äº§å“åªæœ‰å‡ºè€Œæ²¡æœ‰å…¥ï¼Œå“ªæ€•åªæ˜¯å¢åŠ åº“å­˜éƒ½ä¸è¡ŒğŸ˜‘ï¼ŒåŒç†ï¼ŒåŸæ–™åªæœ‰å…¥è€Œæ²¡æœ‰å‡ºï¼Œåº“å­˜åªä¼šè¶Šç§¯è¶Šå¤šã€‚å°±éå¸¸åœ°ä¸åˆç†ã€‚æ‰€ä»¥å°†ç¡®è®¤è®¢å•æŒ‰é’®æ”¹æˆäº†å…¥åº“å’Œå‡ºåº“ã€‚
![](https://images.starnight.top/img/20220505105457.png)

## äº§å“éƒ¨åˆ†
åœ¨äº§å“éƒ¨åˆ†ï¼Œç‚¹å‡»å…¥åº“æ—¶åªéœ€è¦é€‰æ‹©äº§å“ï¼Œå¹¶å¡«å†™æ•°é‡å’Œå­˜æ”¾åŒºåŸŸå³å¯ï¼Œç‚¹å‡»ç¡®è®¤ååº“å­˜æ•°é‡ä¾¿å¢åŠ å¯¹åº”çš„é‡ã€‚è€Œå‡ºåº“æ—¶ï¼Œåˆ™æ˜¯é€‰æ‹©â€œå¾…å‘è´§â€çŠ¶æ€çš„è®¢å•ï¼Œè¯»å–è®¢å•ä¿¡æ¯å¹¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­ï¼Œè®¾å®šå‡ºåº“æ—¶é—´ï¼Œå½“ç‚¹å‡»ç¡®å®šæ—¶ï¼Œä»åº“å­˜æ•°é‡ä¸­å‡å»è®¢å•æ‰€éœ€çš„äº§å“æ•°ï¼Œåœ¨è¿è¾“ä¸­æ•°é‡ä¸­åŠ ä¸Šè®¢å•çš„äº§å“æ•°ï¼ŒåŒæ—¶å°†é”€å”®è®¢å•ç•Œé¢ä¸­å¯¹åº”çš„è®¢å•é¡¹çš„çŠ¶æ€æ”¹ä¸ºâ€œè¿è¾“ä¸­â€ï¼ˆå³è”åŠ¨éƒ¨åˆ†å†…å®¹ï¼‰
![](https://images.starnight.top/img/20220505105821.png)

![](https://images.starnight.top/img/20220505105850.png)

## åŸæ–™éƒ¨åˆ†
åŸæ–™éƒ¨åˆ†åˆ™å’Œäº§å“éƒ¨åˆ†ç›¸åï¼ŒåŸæ–™éƒ¨åˆ†çš„å‡ºåº“éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è¦å‡ºåº“çš„åŸæ–™ä»¥åŠå‡ºåº“æ•°é‡å³å¯ï¼Œç‚¹å‡»ç¡®è®¤ååº“å­˜æ•°é‡ä¾¿å‡å»å¯¹åº”çš„é‡ã€‚å…¥åº“éƒ¨åˆ†åˆ™å¯¹åº”è®¢å•ç®¡ç†ï¼Œé€‰æ‹©â€œè¿è¾“ä¸­â€çŠ¶æ€çš„è®¢å•ï¼Œè¯»å–è®¢å•ä¿¡æ¯å¹¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­ï¼Œè®¾å®šå…¥åº“æ—¶é—´å’Œå­˜æ”¾åŒºåŸŸï¼Œç‚¹å‡»ç¡®å®šæ—¶ï¼Œä¾¿ä»è¿è¾“ä¸­æ•°é‡ä¸­å‡å»å¯¹åº”çš„åŸæ–™æ•°ï¼Œå¹¶åœ¨åº“å­˜æ•°é‡ä¸­åŠ ä¸Šå¯¹åº”çš„é‡ï¼ŒåŒæ—¶å°†é‡‡è´­è®¢å•ä¸­å¯¹åº”çš„è®¢å•é¡¹çŠ¶æ€ä¿®æ”¹ä¸ºâ€œå·²å®Œæˆâ€
![](https://images.starnight.top/img/20220505110230.png)

![](https://images.starnight.top/img/20220505110351.png)


# Roomã€viewModel
Roomæ•°æ®è¡¨è®¾è®¡å¤§ä½“å’Œ[ç¬¬ä¸€éƒ¨åˆ†](obsidian://open?vault=Obsidian&file=E%20-%20Output%2F%E6%AF%95%E8%AE%BE%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0%2F%E7%83%9F%E8%8D%89%E4%BB%93%E5%82%A8%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89)ç±»ä¼¼ï¼Œæ·»åŠ äº†å‡ ä¸ªå­—æ®µï¼Œä¾‹å¦‚äº§å“çš„å›¾ç‰‡åœ°å€ç­‰ï¼Œè¿™é‡Œä¸å†™äº†ã€‚ä¸»è¦è¿˜æ˜¯æ•´ä¸ªRoomæ•°æ®çš„æµç¨‹ã€‚
## 1. åˆ›å»ºEntityã€Daoã€Database
è¿™äº›éƒ¨åˆ†å†…å®¹éƒ½åœ¨[ç¬¬ä¸€éƒ¨åˆ†](obsidian://open?vault=Obsidian&file=E%20-%20Output%2F%E6%AF%95%E8%AE%BE%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0%2F%E7%83%9F%E8%8D%89%E4%BB%93%E5%82%A8%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89)å®Œæˆäº†ã€‚
## 2. åˆ›å»ºViewModelç±»
æ‰€æœ‰å¯¹é¡µé¢æ•°æ®çš„è®¿é—®å…¨éƒ½æ”¾åœ¨ViewModelç±»ä¸­ï¼Œåœ¨Fragmentä¸­è°ƒç”¨ViewModelä¸­çš„æ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚åœ¨ViewModelä¸­å­˜å‚¨ä¸€ä¸ªå¯¹åº”çš„Daoå¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨daoä¸­çš„æ–¹æ³•æ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œï¼ŒåŒæ—¶åœ¨ViewModelä¸­å®ç°éƒ¨åˆ†å¤šçº¿ç¨‹ï¼Œå› ä¸ºå¯¹æ•°æ®åº“çš„æ“ä½œä¸èƒ½åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚
ä»¥ProductViewModelä¸ºä¾‹
```java
public class ProductViewModel extends AndroidViewModel {  
    private ProductDao dao;  
    private LiveData<List<Product>> listLive;  
  
    public ProductViewModel(@NonNull Application application) {  
        super(application);  
        dao = TestDatabase.Companion.getINSTANCE(application).productDao();  
        listLive = dao.getAllProduct();  
    }  
  
    public void insertProduct(Product... products) {  
        new ProductViewModel.InsertAsyncTask(dao).execute(products);  
    }  
  
    public void updateProduct(Product... products) {  
        new ProductViewModel.UpdateAsyncTask(dao).execute(products);  
    }  
  
    public void deleteProduct(Product... products) {  
        new ProductViewModel.DeleteAsyncTask(dao).execute(products);  
    }  
  
    public List<String> getProductNameList(){  
        return dao.getProductNameList();  
    }  
  
    public List<String> getProductModelListByName(String name){  
        return dao.getProductModelListByName(name);  
    }  
  
    public Double getPriceByModel(String model){  
        return dao.getProductByModel(model).getPrice();  
    }  
  
    public Product getProductByModel(String model){return dao.getProductByModel(model);}  
  
    public LiveData<List<Product>> getAllProductLive() {  
        return listLive;  
    }  
  
    public List<Product> getAllProductNoLive(){  
        return dao.getAllProductNoLive();  
    }  
  
    static class InsertAsyncTask extends AsyncTask<Product, Void, Void> {  
        private ProductDao dao;  
  
        public InsertAsyncTask(ProductDao dao) {  
            this.dao = dao;  
        }  
  
        @Override  
        protected Void doInBackground(Product... products) {  
            try {  
                dao.insertProduct(products);  
                PopTip.show("æ·»åŠ æˆåŠŸ");  
            } catch (Exception exception) {  
                exception.printStackTrace();  
                PopTip.show("æ·»åŠ å‡ºé”™");  
            }  
            return null;  
        }  
    }  
  
    static class UpdateAsyncTask extends AsyncTask<Product, Void, Void> {  
        private ProductDao dao;  
  
        public UpdateAsyncTask(ProductDao dao) {  
            this.dao = dao;  
        }  
  
        @Override  
        protected Void doInBackground(Product... products) {  
            try {  
                dao.updateProduct(products);  
                PopTip.show("ä¿®æ”¹æˆåŠŸ");  
            } catch (Exception exception) {  
                exception.printStackTrace();  
                PopTip.show("ä¿®æ”¹å‡ºé”™");  
            }  
            return null;  
        }  
    }  
  
    static class DeleteAsyncTask extends AsyncTask<Product, Void, Void> {  
        private ProductDao dao;  
  
        public DeleteAsyncTask(ProductDao dao) {  
            this.dao = dao;  
        }  
  
        @Override  
        protected Void doInBackground(Product... products) {  
            dao.deleteProduct(products);  
            return null;        
        }  
    }  
}
```
å› ä¸º`getAllProductLive`æ–¹æ³•è¿”å›çš„LiveDataç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥ç³»ç»Ÿåœ¨åº•å±‚å·²ç»å®ç°äº†å­çº¿ç¨‹çš„æ“ä½œï¼Œæœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å†è‡ªå·±å®ç°ï¼Œè€ŒInsertç­‰æ–¹æ³•å°±éœ€è¦è‡ªå·±å®ç°ï¼Œè¿™é‡Œä½¿ç”¨AsyncTask(è™½ç„¶å·²ç»è¢«å¼ƒç”¨äº†)ï¼Œè‡ªå®šä¹‰å¯¹åº”çš„æ“ä½œç±»ï¼Œç»§æ‰¿AsyncTaskï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥daoå¯¹è±¡ï¼Œåœ¨doInBackgroundæ–¹æ³•ä¸­æ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚ç„¶åViewModelä¸­æä¾›ä¸€ä¸ªå…¬å…±æ–¹æ³•ä¾›å¤–éƒ¨è°ƒç”¨ï¼Œåœ¨æ–¹æ³•ä¸­æ–°å»ºæ“ä½œç±»å¹¶æ‰§è¡Œå…¶æ“ä½œã€‚
**é”™è¯¯å¤„ç†**
åœ¨Daoçš„Insertç­‰æ–¹æ³•ä¸­æ·»åŠ æ³¨è§£`@Throws(Exception::class)`ï¼Œé€šè¿‡æ³¨è§£æ¥æŠ›å‡ºé”™è¯¯ï¼Œåœ¨doInBackgroundä¸­æ•è·é”™è¯¯å¹¶åšå‡ºå¯¹åº”çš„æ“ä½œã€‚
## 3. åœ¨Fragmentä¸­ä½¿ç”¨åŸºç¡€å¢åˆ æ”¹æŸ¥æ–¹æ³•
åœ¨Fragmentä¸­é¦–å…ˆå£°æ˜viewModelå¯¹è±¡ï¼Œç„¶ååœ¨onViewCreatedæ–¹æ³•ä¸­ï¼Œé€šè¿‡ViewModelProviderå¯¹viewModelè¿›è¡Œåˆå§‹åŒ–ã€‚
```java
ProductViewModel viewModel;
....
//åœ¨onViewCreatedæ–¹æ³•ä¸­åˆå§‹åŒ–
viewModel = new ViewModelProvider(this).get(ProductViewModel.class);
```
æ¥ä¸‹æ¥å½“éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶è°ƒç”¨viewModelæä¾›çš„å…¬å…±æ–¹æ³•å³å¯ã€‚
```java
Product product = new Product(name,model,image,price,usedMaterial);  
viewModel.insertProduct(product);
```

## 4. åœ¨Fragmentä¸­ä½¿ç”¨éåŸºç¡€å¢åˆ æ”¹æŸ¥æ–¹æ³•
æ ¹æ®éœ€æ±‚ä¸åŒï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æŸ¥è¯¢ä¸åŒçš„æ•°æ®ï¼Œè€Œä¸æ˜¯åªæœ‰è¿”å›å…¨éƒ¨æ•°æ®çš„æ–¹æ³•ã€‚ä¾‹å¦‚åœ¨ä¸Šè¿°çš„â€œ[SpinneräºŒçº§è”åŠ¨](obsidian://open?vault=Obsidian&file=E%20-%20Output%2F%E6%AF%95%E8%AE%BE%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0%2FAndroid%20Spinner%E4%BA%8C%E7%BA%A7%E8%81%94%E5%8A%A8)â€ä¸­ï¼Œå°±éœ€è¦å…ˆæŸ¥è¯¢æ‰€æœ‰çš„äº§å“åç§°ï¼Œå†æ ¹æ®åç§°æŸ¥è¯¢å‹å·åˆ—è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨Daoä¸­æ·»åŠ å¯¹åº”çš„æ–¹æ³•
```kotlin
@Query("SELECT name FROM product GROUP BY name")  
fun getProductNameList():List<String>  
  
@Query("SELECT model FROM product WHERE name=:name")  
fun getProductModelListByName(name:String):List<String>  
  
@Query("SELECT * FROM product WHERE model=:model")  
fun getProductByModel(model:String):Product
```
æ­¤å¤„è¿”å›çš„æ•°æ®ä¸å†æ˜¯LiveDataï¼Œå°±éœ€è¦è‡ªå·±å®ç°å­çº¿ç¨‹æŸ¥è¯¢ï¼Œè€Œè¿™ä¸ªé€šè¿‡viewModelä¸­çš„AsyncTaskåˆä¼¼ä¹ä¸èƒ½å®ç°ï¼Œæˆ‘è¿˜ä¸çŸ¥é“æ€ä¹ˆèƒ½é€šè¿‡viewModelä¸­çš„AsyncTaskå‘Fragmentä¼ é€’æ•°æ®ï¼Œæ‰€ä»¥æœ€åè¿˜æ˜¯åœ¨Fragmentä¸­é‡‡ç”¨New Threadçš„å½¢å¼æ¥æ‰§è¡Œè¿™äº›æ–¹æ³•ï¼Œå¹¶èµ‹å€¼ç»™Fragmentä¸­å¯¹åº”çš„å˜é‡ã€‚
```java
new Thread(new Runnable() {  
    @Override  
    public void run() {  
        productNameList = productViewModel.getProductNameList();  
        customerList = customerViewModel.getNameList();  
    }  
}).start();
```
# å›¾ç‰‡çš„å¯åŠ¨æ—¶åŠ è½½
è¯¥éƒ¨åˆ†å†…å®¹å¯è§[Androidè¯»å–ç›¸å†Œå›¾ç‰‡å¹¶æ˜¾ç¤º](obsidian://open?vault=Obsidian&file=E%20-%20Output%2F%E6%AF%95%E8%AE%BE%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0%2FAndroid%E8%AF%BB%E5%8F%96%E7%9B%B8%E5%86%8C%E5%9B%BE%E7%89%87%E5%B9%B6%E6%98%BE%E7%A4%BA)
# è®¢å•ç®¡ç†ä¿¡æ¯å’Œåº“å­˜ä¿¡æ¯è”åŠ¨
è¦å®ç°åœ¨è®¢å•ä¿¡æ¯ç®¡ç†ç•Œé¢ä¸­ä¿®æ”¹åº“å­˜ä¿¡æ¯ï¼Œåˆ™éœ€è¦åœ¨è®¢å•ä¿¡æ¯ç®¡ç†çš„Adapterä¸­ä¼ å…¥åº“å­˜ä¿¡æ¯çš„ViewModelç±»ï¼Œç„¶ååœ¨Adapterä¸­è°ƒç”¨åº“å­˜ä¿¡æ¯çš„ViewModelä¸­çš„å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚åŒç†åœ¨åº“å­˜ä¿¡æ¯ä¸­ä¿®æ”¹è®¢å•çŠ¶æ€ä¹Ÿéœ€è¦åœ¨åº“å­˜ä¿¡æ¯é¡µé¢ä¸­ä¼ å…¥è®¢å•çš„ViewModelï¼Œå¹¶ä¿®æ”¹è®¢å•çš„å…¥\å‡ºåº“æ—¶é—´å’Œè®¢å•çŠ¶æ€ï¼Œç„¶åè°ƒç”¨ViewModelä¸­çš„æ›´æ–°æ–¹æ³•ã€‚
```java
order[0].setState(SaleOrder.STATE_DELIVERY);  
order[0].setDeliveryDate(deliveryDate);  
saleOrderViewModel.updateSaleOrder(order);  
  
inventory[0].setHostCount(inventory[0].getHostCount()-count);  
inventory[0].setDeliveryCount(inventory[0].getDeliveryCount()+count);  
viewModel.updateInventory(inventory[0]);
```
# é‡åˆ°çš„é—®é¢˜
## Only the original thread that created a view hierarchy can touch its views.
è¿™é‡Œçš„æŠ¥é”™åŸå› æ˜¯åœ¨å­çº¿ç¨‹ä¸­ç›´æ¥æ“ä½œUIï¼Œè¿˜æ˜¯SpinneräºŒçº§è”åŠ¨ä¸­å‡ºç°çš„é—®é¢˜ï¼Œå› ä¸ºéœ€è¦æ ¹æ®ç¬¬ä¸€ä¸ªSpinnerä¸­çš„åç§°æ¥æŸ¥è¯¢å‹å·åˆ—è¡¨å¹¶å¡«å……åˆ°ç¬¬äºŒä¸ªSpinnerä¸­ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥å¼€äº†å­çº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢å’Œå¡«å……æ“ä½œã€‚
```java
new Thread(new Runnable() {  
    @Override  
    public void run() {  
        String name = spinnerName.getSelectedItem().toString();  
        materialModelList =  materialViewModel.getMaterialModelListByName(name);
        ArrayAdapter<String> modelAdapter = new ArrayAdapter<String>(getContext(), com.lihang.R.layout.support_simple_spinner_dropdown_item,modelList);  
		spinnerModel.setAdapter(modelAdapter);   
    }  
}).start();
```
è¿™é‡Œæˆ‘ç›´æ¥é€šè¿‡`spinnerModel.setAdapter()`å¯¹UIè¿›è¡Œäº†æ“ä½œï¼Œæ‰€ä»¥æŠ¥äº†è¿™ä¸ªé”™ï¼ˆä¸çŸ¥ä¸ºå•¥æˆ‘ä¹‹å‰è¿™ä¹ˆç”¨ä¹Ÿæ²¡æŠ¥é”™\==ï¼‰
**è§£å†³æ–¹æ³•**
ä½¿ç”¨Handleræ¥å¯¹UIè¿›è¡Œæ“ä½œï¼Œåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œå®Œæˆæ—¶é€šè¿‡Messageæ¥ä¼ é€’æ•°æ®ç»™Handlerï¼ŒHandleræ¥æ”¶åˆ°ä¿¡æ¯åæ›´æ–°UI
```java
Handler mHandler = new Handler(Looper.myLooper()){  
    @Override  
    public void handleMessage(@NonNull Message msg) {  
        super.handleMessage(msg);  
        if(msg.what == SET_SECOND_SPINNER){  
            List<String> modelList = msg.getData().getStringArrayList("modelList");  
            ArrayAdapter<String> modelAdapter = new ArrayAdapter<String>(getContext(), com.lihang.R.layout.support_simple_spinner_dropdown_item,modelList);  
            spinnerModel.setAdapter(modelAdapter);  
        }  
    }  
};  
spinnerName.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {  
    @Override  
    public void onItemSelected(AdapterView<?> adapterView, View view, int i, long l) {  
        materialModelList.clear();  
        new Thread(new Runnable() {  
            @Override  
            public void run() {  
                String name = spinnerName.getSelectedItem().toString();  
                materialModelList =  materialViewModel.getMaterialModelListByName(name);  
                Message message = Message.obtain();  
                message.what = SET_SECOND_SPINNER;;  
                Bundle bundle = new Bundle();  
                bundle.putStringArrayList("modelList", (ArrayList<String>) materialModelList);  
                message.setData(bundle);  
                mHandler.sendMessage(message);  
            }  
        }).start();  
    }  
  
    @Override  
    public void onNothingSelected(AdapterView<?> adapterView) { }  
});
```
åœ¨ä½¿ç”¨æ—¶å‘ç°Hanlderè¢«å¼ƒç”¨äº†\==ï¼Œäºæ˜¯æŸ¥è¯¢æœ‰æ²¡æœ‰ä»€ä¹ˆæ›¿ä»£ï¼Œå‘ç°ç›´æ¥å¼ƒç”¨äº†Handlerçš„æ— å‚æ„é€ å‡½æ•°ï¼Œåªè¦ç›´æ¥æŒ‡å®šLooperå¯¹è±¡å°±è¡Œäº†ã€‚
- åœ¨ä¸»çº¿ç¨‹å†…è¿è¡Œï¼ŒæŒ‡å®šä¸ºä¸»çº¿ç¨‹çš„Looper
```java
Handler mhandler = new Handler(Looper.getMainLooper());
```
- åœ¨å½“å‰çº¿ç¨‹å†…è¿è¡Œï¼ŒæŒ‡å®šä¸ºå½“å‰çº¿ç¨‹çš„Looper
```java
Handler mhandler = new Handler(Looper.myLooper());
```

> [Androidå¸¸è§æŠ¥é”™ä¹‹ - Only the original thread that created a view hierarchy can touch its views](https://blog.csdn.net/BruceZong/article/details/83964218)
> [Android Handlerè¢«å¼ƒç”¨ï¼Œé‚£ä¹ˆä»¥åæ€ä¹ˆä½¿ç”¨Handlerï¼Œæˆ–è€…ç±»ä¼¼çš„åŠŸèƒ½](https://blog.csdn.net/John_Lenon/article/details/124529515)
# ToDo
- [ ]  ç™»å½•æ³¨å†Œç•Œé¢
- [ ]  æŠ¥è¡¨åˆ†æç•Œé¢
- [ ]  ç®¡ç†å‘˜çš„æƒé™é‰´åˆ«
- [ ]  æ¨¡ç³Šæœç´¢åŠŸèƒ½